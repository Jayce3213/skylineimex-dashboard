<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tra cứu XNK - SkylineIMEX</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .header { background: linear-gradient(135deg, #0d6efd, #0a58ca); color: white; padding: 1rem 0; }
    .btn-search { background-color: #0d6efd; border: none; font-weight: bold; }
    .btn-search:hover { background-color: #0b5ed7; }
    .card { box-shadow: 0 4px 15px rgba(0,0,0,0.1); border-radius: 12px; }
    .table th { background-color: #e9ecef; font-weight: 600; }
    .badge { font-size: 0.9em; }
    .skyline-footer { background-color: #f8f9fa; color: #6c757d; font-size: 0.9em; padding: 1rem 0; margin-top: 3rem; }
  </style>
</head>
<body class="bg-light">

  <!-- HEADER SKYLINEIMEX --> 
  <nav class="navbar navbar-expand-lg header shadow-sm">
    <div class="container">
      <a class="navbar-brand fw-bold fs-4 text-white" href="/">SkylineIMEX</a>
      <div class="d-flex align-items-center">
        <span class="text-white me-3">Xin chào, <strong>{{ user.name }}</strong>!</span>
        <a href="/logout" class="btn btn-outline-light btn-sm">Đăng xuất</a>
      </div>
    </div>
  </nav>

  <div class="container mt-5">
    <div class="row justify-content-center">
      <div class="col-lg-11">
        <div class="card">
          <div class="card-header bg-success text-white text-center py-3 rounded-top">
            <h3 class="mb-0">TRA CỨU DỮ LIỆU XUẤT NHẬP KHẨU TOÀN CẦU</h3>
          </div>
          <div class="card-body p-4">

            <!-- FORM TÌM KIẾM -->
            <div class="row g-3 mb-4 align-items-end">
              <div class="col-md-3">
                <label class="form-label fw-bold text-primary">HS Code / Từ khóa</label>
                <input type="text" class="form-control form-control-lg" id="query" placeholder="VD: 0901, cà phê, buyer..." value="0901">
              </div>
              <div class="col-md-2">
                <label class="form-label fw-bold text-primary">Từ ngày</label>
                <input type="date" class="form-control" id="fromDate" value="2024-01-01">
              </div>
              <div class="col-md-2">
                <label class="form-label fw-bold text-primary">Đến ngày</label>
                <input type="date" class="form-control" id="toDate">
              </div>
              <div class="col-md-2">
                <label class="form-label fw-bold text-primary">Quốc gia nhập</label>
                <select class="form-select" id="importer">
                  <option value="">Tất cả</option>
                  <option value="AE">UAE</option>
                  <option value="US">Mỹ</option>
                  <option value="CN">Trung Quốc</option>
                  <option value="IN">Ấn Độ</option>
                  <option value="KR">Hàn Quốc</option>
                </select>
              </div>
              <div class="col-md-3">
                <button type="button" class="btn btn-search btn-lg w-100 text-white" onclick="search()">
                  TÌM KIẾM
                </button>
              </div>
            </div>

            <!-- KẾT QUẢ -->
            <div id="results" class="mt-3">
              <div class="text-center text-muted py-5">
                <h5>Nhập thông tin và nhấn "Tìm kiếm" để xem dữ liệu toàn cầu</h5>
                <p class="text-secondary">Dữ liệu được cập nhật hàng ngày từ hệ thống SkylineIMEX</p>
              </div>
            </div>

            <div class="text-end mt-3">
              <button class="btn btn-success btn-lg" id="exportBtn" onclick="exportCSV()" disabled>
                XUẤT FILE EXCEL
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- FOOTER SKYLINEIMEX -->
  <footer class="skyline-footer text-center">
    <div class="container">
      <p class="mb-0">&copy; 2025 SkylineIMEX. Tất cả dữ liệu được bảo mật và cập nhật tự động.</p>
    </div>
  </footer>

  <script>
    let results = [];

    async function search() {
      const query = document.getElementById('query').value.trim();
      const from = document.getElementById('fromDate').value;
      const to = document.getElementById('toDate').value;
      const importer = document.getElementById('importer').value;

      if (!query) {
        alert('Vui lòng nhập HS Code hoặc từ khóa!');
        return;
      }

      const btn = document.querySelector('button[onclick="search()"]');
      btn.disabled = true;
      btn.innerHTML = 'Đang tra cứu...';

      try {
        const url = `/api/search?q=${encodeURIComponent(query)}&from=${from}&to=${to}&importer=${importer}`;
        const res = await fetch(url);
        const data = await res.json();

        if (data.error) {
          document.getElementById('results').innerHTML = `<div class="alert alert-danger"><strong>Lỗi:</strong> ${data.error}</div>`;
        } else {
          results = data.data || [];
          displayResults(results);
          document.getElementById('exportBtn').disabled = results.length === 0;
        }
      } catch (e) {
        document.getElementById('results').innerHTML = `<div class="alert alert-danger">Lỗi kết nối. Vui lòng thử lại sau.</div>`;
      }

      btn.disabled = false;
      btn.innerHTML = 'TÌM KIẾM';
    }

    function displayResults(data) {
      if (!data || data.length === 0) {
        document.get
